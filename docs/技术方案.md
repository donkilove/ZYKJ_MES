# MES 技术方案（初版）

## 1. 技术选型

- 前端：Flutter（支持 Web/桌面/移动统一代码基线）。
- 后端：Python + FastAPI（高性能异步接口框架）。
- 数据库：PostgreSQL（事务一致性、索引能力强）。
- ORM：SQLAlchemy + Alembic（模型与迁移管理）。
- 鉴权：JWT + RBAC（角色权限控制）。

## 2. 总体架构

```text
Flutter Client
    |
HTTP/HTTPS + JSON
    |
FastAPI Service
    |-- Auth & RBAC
    |-- User Module
    |-- Product Module
    |-- Product Parameter Module
    |-- Production Order Module
    |-- First Article Module
    |
PostgreSQL
```

## 3. 后端分层建议

- `app/api`：路由层，参数接收与响应格式统一。
- `app/services`：业务逻辑层，承载流程编排与规则校验。
- `app/repositories`：数据访问层，封装数据库操作。
- `app/models`：ORM 模型定义。
- `app/schemas`：Pydantic 请求/响应模型。
- `app/core`：配置、鉴权、中间件、异常处理。

## 4. 前端分层建议（Flutter）

- `lib/pages`：页面层。
- `lib/widgets`：复用组件。
- `lib/models`：数据模型。
- `lib/services`：API 调用封装。
- `lib/state`：状态管理（Riverpod/Bloc 二选一并统一）。
- `lib/router`：路由与页面权限控制。

## 5. 关键设计点

- 统一响应格式：`code`、`message`、`data`。
- 审计字段统一：`created_by`、`created_at`、`updated_by`、`updated_at`。
- 软删除策略：基础资料类表支持 `is_deleted`。
- 业务状态机：订单状态、首件状态严格受控，禁止越级流转。
- 幂等控制：订单创建与首件提报可引入请求幂等键。

## 6. 安全与权限

- 登录后签发 Access Token（短有效期）+ Refresh Token（可选）。
- 后端按接口声明权限码，前端根据权限控制菜单与按钮。
- 所有写操作记录审计日志，含操作者与操作前后值。

## 7. 部署建议（初期）

- 环境划分：`dev`、`test`、`prod`。
- 后端采用 `uvicorn` 启动，生产建议加 `gunicorn` 管理进程。
- PostgreSQL 独立部署并启用定时备份。
- 后续可引入 Docker Compose 简化环境一致性。
