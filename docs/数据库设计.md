# MES 数据库设计草案（PostgreSQL）

## 1. 设计原则

- 主键统一使用 `bigserial` 或 `uuid`（二选一，项目内保持一致）。
- 全表保留审计字段：`created_at`、`created_by`、`updated_at`、`updated_by`。
- 关键业务表保留 `status` 字段实现状态流转控制。
- 查询高频字段必须建立索引。

## 2. 核心表清单

### 2.1 用户与权限

- `sys_user`：用户表
- `sys_role`：角色表
- `sys_permission`：权限表
- `sys_user_role`：用户角色关联表
- `sys_role_permission`：角色权限关联表

### 2.2 产品域

- `mes_product`：产品主数据
- `mes_product_param_template`：产品参数模板
- `mes_product_param_item`：参数项定义
- `mes_product_param_value`：产品参数值

### 2.3 订单域

- `mes_production_order`：生产订单主表
- `mes_production_order_item`：生产订单明细（可选）
- `mes_order_status_log`：订单状态变更日志

### 2.4 首件域

- `mes_first_article`：首件记录主表
- `mes_first_article_check_item`：首件检验项
- `mes_first_article_audit_log`：首件审核日志

## 3. 关键字段建议

### 3.1 `mes_product`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | bigint | 主键 |
| product_code | varchar(64) | 产品编码，唯一 |
| product_name | varchar(128) | 产品名称 |
| product_spec | varchar(255) | 规格型号 |
| status | smallint | 状态（启用/停用） |
| remark | text | 备注 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

### 3.2 `mes_production_order`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | bigint | 主键 |
| order_no | varchar(64) | 订单号，唯一 |
| product_id | bigint | 关联产品 |
| planned_qty | numeric(18,4) | 计划数量 |
| produced_qty | numeric(18,4) | 已产数量 |
| plan_start_time | timestamp | 计划开始 |
| plan_end_time | timestamp | 计划结束 |
| status | smallint | 状态（新建/下发/生产中/完成/关闭） |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

### 3.3 `mes_first_article`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | bigint | 主键 |
| order_id | bigint | 关联生产订单 |
| batch_no | varchar(64) | 批次号 |
| submit_user_id | bigint | 提报人 |
| submit_time | timestamp | 提报时间 |
| audit_user_id | bigint | 审核人 |
| audit_time | timestamp | 审核时间 |
| audit_result | smallint | 审核结果（通过/驳回） |
| status | smallint | 状态（待审/通过/驳回） |
| remark | text | 备注 |

## 4. 关系与约束

- `mes_production_order.product_id -> mes_product.id`（外键）。
- `mes_first_article.order_id -> mes_production_order.id`（外键）。
- 唯一索引：`mes_product.product_code`、`mes_production_order.order_no`。
- 组合索引：
  - 订单查询：`(status, plan_start_time)`。
  - 首件查询：`(order_id, submit_time)`。

## 5. 数据迁移建议

- 使用 Alembic 管理结构迁移。
- 每次结构调整必须附带回滚脚本。
- 生产变更遵循“先兼容后切换再清理”原则，避免停机。
